minimum_cumulusci_version: '4.6.0'
project:
  name: sfdo-summit-events-agentforce
  package:
    name: sfdo-summit-events-agentforce
    api_version: '63.0'
  dependencies:
    - github: 'https://github.com/SFDO-Community/Summit-Events-App'
  git:
    default_branch: 'main'
  source_format: sfdx
sources:
  sea:
    github: 'https://github.com/SFDO-Community/Summit-Events-App'
    branch: 'master'

tasks:
  robot:
    options:
      suites: robot/sfdo-summit-events-agentforce/tests
      options:
        outputdir: robot/sfdo-summit-events-agentforce/results

  robot_testdoc:
    options:
      path: robot/sfdo-summit-events-agentforce/tests
      output: robot/sfdo-summit-events-agentforce/doc/sfdo-summit-events-agentforce_tests.html

  run_tests:
    options:
      required_org_code_coverage_percent: 75

  check_namespace_box:
    description: "Check the namespace box in the org"
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      apex: >
        summit__Summit_Events_Settings__c eventSettings = summit__Summit_Events_Settings__c.getOrgDefaults();
        eventSettings.summit__Managed_Package__c = true;
        upsert eventSettings;  

  deploy_guest_permission_set:
    description: Give System Admins Event Admin Permission Set
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    options:
      namespace_inject: $project_config.project__package__namespace
      apex: >
        String siteName = 'Summit_Events';

        Site site = [
                SELECT GuestUserId
                FROM Site
                WHERE Name = :siteName
        ];

        List<PermissionSet> eventPermissionSets;
        eventPermissionSets = [SELECT Name, Id FROM PermissionSet WHERE Name = 'Summit_Events_Registrant_Custom'];

        List<PermissionSetAssignment> permissionSetList = new List<PermissionSetAssignment>();
        if (!eventPermissionSets.isEmpty()) {
                permissionSetList.add(new PermissionSetAssignment(PermissionSetId = eventPermissionSets[0].Id, AssigneeId = site.GuestUserId));
        }
        if (!permissionSetList.isEmpty()) {
            upsert permissionSetList;
        }

flows:
  config_dev:
    steps:
      3:
        task: sea:deploy_permission_set
      4:
        task: sea:deploy_site_config
      5:
        task: sea:deploy_site_settings
      6:
        task: sea:deploy_guest_permission_set
      7:
        task: sea:load_sample_data
      8:
        task: deploy_guest_permission_set
      9:
        task: check_namespace_box
